<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiteCore | Панель разработчика</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Все существующие стили остаются без изменений */
        /* Добавляем только индикатор загрузки */
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--gray-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Шапка -->
    <div class="header">
        <div class="header-top">
            <a href="#" class="logo" onclick="showSection('orders')">
                <div class="logo-icon">SC</div>
                <div class="logo-text">SiteCore</div>
            </a>
            
            <div class="user-menu">
                <div class="user-info" id="current-user-info">
                    <!-- Заполняется JavaScript -->
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </button>
            </div>
        </div>
        
        <!-- Навигация -->
        <div class="nav-menu">
            <button class="nav-item active" onclick="showSection('orders')">
                <i class="fas fa-tasks"></i> Заказы
                <span class="nav-badge" id="orders-badge">0</span>
            </button>
            <button class="nav-item" onclick="showSection('clients')">
                <i class="fas fa-users"></i> Клиенты
                <span class="nav-badge" id="clients-badge">0</span>
            </button>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="container">
        <!-- Приветствие -->
        <div class="welcome-section">
            <div class="welcome-header">
                <h1 id="welcome-title">Загрузка...</h1>
                <div class="stats-badge" id="stats-badge">
                    <i class="fas fa-chart-line"></i>
                    <span>Загрузка...</span>
                </div>
            </div>
            
            <div class="welcome-info">
                <h2 id="developer-name">Разработчик</h2>
                <p>Управляйте заказами, общайтесь с клиентами и создавайте отличные сайты.</p>
                <div class="quick-stats" id="quick-stats">
                    <!-- Заполняется JavaScript -->
                </div>
            </div>
        </div>

        <!-- Заказы -->
        <section id="orders-section" class="content-section active">
            <div class="section-header">
                <h2>Управление заказами</h2>
                <div style="display: flex; gap: 10px;">
                    <select id="orders-filter" class="form-control" style="width: auto;" onchange="filterOrders()">
                        <option value="all">Все заказы</option>
                        <option value="new">Новые</option>
                        <option value="in-progress">В работе</option>
                        <option value="review">На проверке</option>
                        <option value="completed">Завершенные</option>
                        <option value="cancelled">Отмененные</option>
                    </select>
                    <button class="btn btn-primary" onclick="refreshOrders()">
                        <i class="fas fa-sync-alt"></i> Обновить
                    </button>
                </div>
            </div>
            
            <div class="orders-grid" id="orders-grid">
                <!-- Заказы загружаются через JavaScript -->
            </div>
        </section>

        <!-- Клиенты -->
        <section id="clients-section" class="content-section">
            <div class="section-header">
                <h2>Клиенты платформы</h2>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="clients-search" class="form-control" placeholder="Поиск клиентов..." style="width: 250px;" onkeyup="searchClients()">
                    <button class="btn btn-primary" onclick="refreshClients()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="clients-grid" id="clients-grid">
                <!-- Клиенты загружаются через JavaScript -->
            </div>
        </section>
    </div>

    <!-- Модальное окно чата -->
    <div class="modal" id="chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="chat-modal-title">Общение с клиентом</h3>
                <button class="modal-close" onclick="closeChatModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <!-- Сообщения загружаются через JavaScript -->
                    </div>
                    <div class="chat-input-container">
                        <textarea id="chat-input" placeholder="Введите сообщение..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) {event.preventDefault(); sendMessage();}"></textarea>
                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно управления заказом -->
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="order-modal-title">Управление заказом</h3>
                <button class="modal-close" onclick="closeOrderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h4 style="margin-bottom: 15px;">Информация о заказе</h4>
                        <div style="background: var(--gray-lighter); border-radius: 12px; padding: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">Клиент</div>
                                    <div style="font-weight: 600;" id="modal-client-name"></div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">Email</div>
                                    <div style="font-weight: 600;" id="modal-client-email"></div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">Тип сайта</div>
                                    <div style="font-weight: 600;" id="modal-project-type"></div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">Бюджет</div>
                                    <div style="font-weight: 600;" id="modal-project-budget"></div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">Срок</div>
                                    <div style="font-weight: 600;" id="modal-project-deadline"></div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">Статус</div>
                                    <div style="font-weight: 600;" id="modal-project-status"></div>
                                </div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 30px 0 15px;">Промт от клиента</h4>
                        <div style="background: var(--gray-lighter); border-radius: 12px; padding: 20px; max-height: 200px; overflow-y: auto;">
                            <div id="modal-project-prompt"></div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 15px;">Действия</h4>
                        <div style="background: var(--gray-lighter); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <select id="status-select" class="form-control" onchange="updateOrderStatus()">
                                    <option value="new">Новый</option>
                                    <option value="in-progress">В работе</option>
                                    <option value="review">На проверке</option>
                                    <option value="completed">Завершен</option>
                                    <option value="cancelled">Отменен</option>
                                </select>
                                
                                <button class="btn btn-primary" onclick="takeOrder()" id="take-order-btn">
                                    <i class="fas fa-hand-paper"></i> Взять в работу
                                </button>
                                
                                <button class="btn btn-success" onclick="completeOrder()" id="complete-order-btn" style="display: none;">
                                    <i class="fas fa-check"></i> Завершить заказ
                                </button>
                                
                                <button class="btn btn-warning" onclick="openChatModal()">
                                    <i class="fas fa-comment"></i> Написать клиенту
                                </button>
                                
                                <button class="btn btn-danger" onclick="deleteOrder()">
                                    <i class="fas fa-trash"></i> Удалить заказ
                                </button>
                            </div>
                        </div>
                        
                        <h4 style="margin: 30px 0 15px;">Контакт клиента</h4>
                        <div style="background: var(--gray-lighter); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <i class="fas fa-phone" style="color: var(--primary);"></i>
                                <div>
                                    <div style="font-size: 12px; color: var(--gray);">Телефон</div>
                                    <div style="font-weight: 600;" id="modal-client-phone"></div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fab fa-telegram" style="color: var(--primary);"></i>
                                <div>
                                    <div style="font-size: 12px; color: var(--gray);">Telegram</div>
                                    <div style="font-weight: 600;" id="modal-client-telegram"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Уведомление -->
    <div class="notification" id="notification"></div>

    <!-- Индикатор загрузки -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Загрузка данных...</p>
    </div>

    <script>
        // Глобальные переменные
        let currentUser = null;
        let database = {
            users: { clients: [], developers: [] },
            orders: [],
            messages: []
        };
        let currentChatOrderId = null;
        let currentOrderId = null;

        // Конфигурация базы данных
        const DB_CONFIG = {
            API_URL: 'https://api.jsonbin.io/v3/b',
            BIN_ID: '66b3d9c5ad19ca34f8c48e0d',
            API_KEY: '$2b$10$LQYjMwTj2wXGJfX8b7K6DeoEJpJX5qYQY9t8rFqGtHvK1lM3nP4oS'
        };

        // Инициализация
        async function init() {
            console.log('Инициализация панели разработчика...');
            
            // Показываем индикатор загрузки
            document.getElementById('loading-overlay').classList.add('active');
            
            // Проверка авторизации разработчика
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                console.log('Пользователь не найден в localStorage');
                window.location.href = 'index.html';
                return;
            }

            try {
                currentUser = JSON.parse(userData);
                console.log('Текущий пользователь:', currentUser);
                
                // Проверяем, что это разработчик
                if (currentUser.type !== 'developer') {
                    console.log('Пользователь не разработчик, редирект на клиентскую панель');
                    window.location.href = 'client.html';
                    return;
                }
                
                // Обновляем информацию о пользователе
                updateUserInfo();
                
                // Загружаем базу данных
                await loadDatabase();
                
                // Загружаем данные
                loadDashboardData();
                loadOrders();
                loadClients();
                
                // Скрываем индикатор загрузки
                document.getElementById('loading-overlay').classList.remove('active');
                
                console.log('Панель разработчика успешно загружена');
                
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                document.getElementById('loading-overlay').classList.remove('active');
                showNotification('Ошибка загрузки данных', 'error');
            }
        }

        // Загрузка базы данных
        async function loadDatabase() {
            try {
                console.log('Загрузка базы данных...');
                
                // Пробуем загрузить из JSONBin
                const response = await fetch(`${DB_CONFIG.API_URL}/${DB_CONFIG.BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': DB_CONFIG.API_KEY }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Данные получены:', data);
                    
                    if (data.record) {
                        database = data.record;
                        console.log('База данных успешно загружена');
                    } else {
                        console.log('Пустая база данных, создаем структуру');
                        database = {
                            users: { 
                                clients: [], 
                                developers: [] 
                            },
                            orders: [],
                            messages: []
                        };
                    }
                    
                    // Сохраняем локальную копию
                    localStorage.setItem('sitecore_database', JSON.stringify(database));
                    return true;
                } else {
                    throw new Error('Ошибка ответа сервера');
                }
            } catch (error) {
                console.warn('Ошибка загрузки из облака:', error);
                
                // Используем локальную копию
                const localData = localStorage.getItem('sitecore_database');
                if (localData) {
                    try {
                        database = JSON.parse(localData);
                        console.log('Используем локальную копию базы данных');
                        return true;
                    } catch (parseError) {
                        console.error('Ошибка парсинга локальных данных:', parseError);
                    }
                }
                
                // Создаем пустую структуру
                database = {
                    users: { clients: [], developers: [] },
                    orders: [],
                    messages: []
                };
                
                console.log('Создана новая база данных');
                return false;
            }
        }

        // Сохранение базы данных
        async function saveDatabase() {
            try {
                console.log('Сохранение базы данных...');
                
                const response = await fetch(`${DB_CONFIG.API_URL}/${DB_CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DB_CONFIG.API_KEY
                    },
                    body: JSON.stringify(database)
                });
                
                if (response.ok) {
                    // Сохраняем локальную копию
                    localStorage.setItem('sitecore_database', JSON.stringify(database));
                    console.log('База данных сохранена');
                    return true;
                } else {
                    throw new Error('Ошибка сохранения');
                }
            } catch (error) {
                console.error('Ошибка сохранения в облако:', error);
                
                // Сохраняем локальную копию на всякий случай
                localStorage.setItem('sitecore_database', JSON.stringify(database));
                return false;
            }
        }

        // Обновление информации пользователя
        function updateUserInfo() {
            if (!currentUser) return;
            
            document.getElementById('current-user-info').innerHTML = `
                <div class="user-avatar">${currentUser.avatar || 'Р'}</div>
                <div class="user-name">${currentUser.name || 'Разработчик'}</div>
            `;

            document.getElementById('developer-name').textContent = currentUser.name || 'Разработчик';
            
            // Заголовок приветствия
            const now = new Date();
            const hours = now.getHours();
            let greeting;
            
            if (hours < 12) greeting = 'Доброе утро';
            else if (hours < 18) greeting = 'Добрый день';
            else greeting = 'Добрый вечер';
            
            document.getElementById('welcome-title').textContent = `${greeting}, ${currentUser.name || 'Разработчик'}!`;
        }

        // Загрузка данных дашборда
        function loadDashboardData() {
            if (!database || !database.orders) return;
            
            const orders = database.orders;
            const myOrders = orders.filter(order => order.assignedTo === currentUser.id);
            const availableOrders = orders.filter(order => !order.assignedTo && order.status === 'new');
            
            document.getElementById('stats-badge').innerHTML = `
                <i class="fas fa-chart-line"></i>
                <span>Активных заказов: ${myOrders.length}</span>
            `;
            
            document.getElementById('quick-stats').innerHTML = `
                <div class="quick-stat">
                    <div class="quick-stat-value">${availableOrders.length}</div>
                    <div class="quick-stat-label">Доступных заказов</div>
                </div>
                <div class="quick-stat">
                    <div class="quick-stat-value">${myOrders.length}</div>
                    <div class="quick-stat-label">Мои заказы</div>
                </div>
                <div class="quick-stat">
                    <div class="quick-stat-value">${myOrders.filter(o => o.status === 'completed').length}</div>
                    <div class="quick-stat-label">Завершено</div>
                </div>
                <div class="quick-stat">
                    <div class="quick-stat-value">${database.users.clients?.length || 0}</div>
                    <div class="quick-stat-label">Клиентов</div>
                </div>
            `;
        }

        // Показать раздел
        function showSection(section) {
            // Обновляем активные пункты меню
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            // Показываем выбранный раздел
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(section + '-section').classList.add('active');
        }

        // Загрузка заказов
        function loadOrders() {
            if (!database || !database.orders) {
                console.log('Нет данных о заказах');
                return;
            }
            
            const filter = document.getElementById('orders-filter').value;
            let orders = database.orders;
            
            // Применяем фильтр
            if (filter !== 'all') {
                orders = orders.filter(order => order.status === filter);
            }
            
            // Сортируем по дате (новые сначала)
            orders.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
            
            // Обновляем статистику
            const allOrders = database.orders;
            const newOrders = allOrders.filter(o => o.status === 'new').length;
            const myOrders = allOrders.filter(o => o.assignedTo === currentUser.id);
            
            document.getElementById('orders-badge').textContent = newOrders;
            
            // Отображаем заказы
            const container = document.getElementById('orders-grid');
            if (!container) return;
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--gray); grid-column: 1/-1;">
                        <i class="fas fa-clipboard-list" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="margin-bottom: 10px;">Заказы не найдены</h3>
                        <p>Измените параметры фильтра или загляните позже</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map(order => {
                const client = database.users.clients?.find(c => c.id === order.clientId) || order;
                const statusTexts = {
                    'new': 'Новый',
                    'in-progress': 'В работе',
                    'review': 'На проверке',
                    'completed': 'Завершен',
                    'cancelled': 'Отменен'
                };
                
                const statusColors = {
                    'new': 'status-new',
                    'in-progress': 'status-progress',
                    'review': 'status-review',
                    'completed': 'status-completed',
                    'cancelled': 'status-cancelled'
                };
                
                // Проверяем, назначен ли заказ текущему разработчику
                const isAssignedToMe = order.assignedTo === currentUser.id;
                const isAvailable = !order.assignedTo && order.status === 'new';
                
                return `
                    <div class="order-card" onclick="openOrderModal('${order.id}')">
                        <div class="order-card-header">
                            <div>
                                <h3>${order.projectName || 'Без названия'}</h3>
                                <div class="order-client">${client.name || order.clientName || 'Клиент не указан'}</div>
                            </div>
                            <div class="order-status ${statusColors[order.status] || 'status-new'}">
                                ${statusTexts[order.status] || 'Новый'}
                            </div>
                        </div>
                        
                        <div class="order-card-body">
                            <div class="order-details">
                                <div class="order-detail">
                                    <div class="order-detail-label">Тип</div>
                                    <div class="order-detail-value">${order.projectType === 'static' ? 'Статический' : 'Динамический'}</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Бюджет</div>
                                    <div class="order-detail-value">${formatCurrency(order.budget || 0)}</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Срок</div>
                                    <div class="order-detail-value">${order.deadline || 0} дней</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Статус</div>
                                    <div class="order-detail-value">
                                        ${isAssignedToMe ? 'Ваш заказ' : isAvailable ? 'Доступен' : 'Назначен'}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="order-prompt-preview">
                                ${(order.prompt || 'Нет описания').substring(0, 150)}...
                            </div>
                        </div>
                        
                        <div class="order-actions">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); openOrderModal('${order.id}')">
                                <i class="fas fa-edit"></i> Управлять
                            </button>
                            ${isAvailable ? `
                                <button class="btn btn-success" onclick="event.stopPropagation(); takeOrder('${order.id}')">
                                    <i class="fas fa-hand-paper"></i> Взять
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Фильтрация заказов
        function filterOrders() {
            loadOrders();
        }

        // Обновление заказов
        async function refreshOrders() {
            await loadDatabase();
            loadOrders();
            showNotification('Заказы обновлены', 'success');
        }

        // Открыть модальное окно заказа
        function openOrderModal(orderId) {
            currentOrderId = orderId;
            const order = database.orders.find(o => o.id === orderId);
            if (!order) {
                showNotification('Заказ не найден', 'error');
                return;
            }
            
            const client = database.users.clients?.find(c => c.id === order.clientId) || order;
            
            // Заполняем информацию
            document.getElementById('order-modal-title').textContent = order.projectName || 'Без названия';
            document.getElementById('modal-client-name').textContent = client.name || order.clientName || 'Клиент не указан';
            document.getElementById('modal-client-email').textContent = client.email || order.clientEmail || 'Не указан';
            document.getElementById('modal-client-phone').textContent = client.phone || order.clientPhone || 'Не указан';
            document.getElementById('modal-client-telegram').textContent = client.telegram ? '@' + client.telegram : (order.clientTelegram || 'Не указан');
            document.getElementById('modal-project-type').textContent = order.projectType === 'static' ? 'Статический сайт' : 'Динамический сайт';
            document.getElementById('modal-project-budget').textContent = formatCurrency(order.budget || 0);
            document.getElementById('modal-project-deadline').textContent = `${order.deadline || 0} дней`;
            document.getElementById('modal-project-status').textContent = getStatusText(order.status);
            document.getElementById('modal-project-prompt').textContent = order.prompt || 'Нет описания';
            
            // Устанавливаем текущий статус
            document.getElementById('status-select').value = order.status;
            
            // Показываем/скрываем кнопки
            const takeOrderBtn = document.getElementById('take-order-btn');
            const completeOrderBtn = document.getElementById('complete-order-btn');
            
            if (order.assignedTo && order.assignedTo !== currentUser.id) {
                takeOrderBtn.style.display = 'none';
                completeOrderBtn.style.display = 'none';
            } else if (order.assignedTo === currentUser.id) {
                takeOrderBtn.style.display = 'none';
                if (order.status !== 'completed' && order.status !== 'cancelled') {
                    completeOrderBtn.style.display = 'block';
                } else {
                    completeOrderBtn.style.display = 'none';
                }
            } else {
                takeOrderBtn.style.display = 'block';
                completeOrderBtn.style.display = 'none';
            }
            
            // Показываем модальное окно
            document.getElementById('order-modal').classList.add('active');
        }

        // Закрыть модальное окно заказа
        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('active');
            currentOrderId = null;
        }

        // Взять заказ в работу
        async function takeOrder() {
            if (!currentOrderId) return;
            
            const order = database.orders.find(o => o.id === currentOrderId);
            if (!order) return;
            
            order.assignedTo = currentUser.id;
            order.status = 'in-progress';
            order.updatedAt = new Date().toISOString();
            
            // Добавляем системное сообщение
            if (!database.messages) database.messages = [];
            database.messages.push({
                id: 'msg_' + Date.now(),
                orderId: currentOrderId,
                text: `${currentUser.name} взял заказ в работу`,
                sender: 'system',
                timestamp: new Date().toISOString()
            });
            
            // Сохраняем базу
            const saved = await saveDatabase();
            if (saved) {
                showNotification('Заказ взят в работу!', 'success');
                closeOrderModal();
                loadOrders();
                loadDashboardData();
            }
        }

        // Завершить заказ
        async function completeOrder() {
            if (!currentOrderId) return;
            
            if (!confirm('Вы уверены, что хотите завершить этот заказ?')) return;
            
            const order = database.orders.find(o => o.id === currentOrderId);
            if (!order) return;
            
            order.status = 'completed';
            order.updatedAt = new Date().toISOString();
            
            // Добавляем системное сообщение
            if (!database.messages) database.messages = [];
            database.messages.push({
                id: 'msg_' + Date.now(),
                orderId: currentOrderId,
                text: `Заказ завершен разработчиком ${currentUser.name}`,
                sender: 'system',
                timestamp: new Date().toISOString()
            });
            
            // Сохраняем базу
            const saved = await saveDatabase();
            if (saved) {
                showNotification('Заказ завершен!', 'success');
                closeOrderModal();
                loadOrders();
                loadDashboardData();
            }
        }

        // Обновить статус заказа
        async function updateOrderStatus() {
            if (!currentOrderId) return;
            
            const status = document.getElementById('status-select').value;
            const order = database.orders.find(o => o.id === currentOrderId);
            if (!order) return;
            
            const oldStatus = order.status;
            order.status = status;
            order.updatedAt = new Date().toISOString();
            
            // Добавляем системное сообщение
            if (!database.messages) database.messages = [];
            database.messages.push({
                id: 'msg_' + Date.now(),
                orderId: currentOrderId,
                text: `Статус изменен с "${getStatusText(oldStatus)}" на "${getStatusText(status)}"`,
                sender: 'system',
                timestamp: new Date().toISOString()
            });
            
            // Сохраняем базу
            const saved = await saveDatabase();
            if (saved) {
                showNotification('Статус обновлен', 'success');
                closeOrderModal();
                loadOrders();
            }
        }

        // Удалить заказ
        async function deleteOrder() {
            if (!currentOrderId) return;
            
            if (!confirm('Вы уверены, что хотите удалить этот заказ? Это действие нельзя отменить.')) return;
            
            const orderIndex = database.orders.findIndex(o => o.id === currentOrderId);
            if (orderIndex === -1) return;
            
            database.orders.splice(orderIndex, 1);
            
            // Сохраняем базу
            const saved = await saveDatabase();
            if (saved) {
                showNotification('Заказ удален', 'success');
                closeOrderModal();
                loadOrders();
                loadDashboardData();
            }
        }

        // Получить текст статуса
        function getStatusText(status) {
            const statuses = {
                'new': 'Новый',
                'in-progress': 'В работе',
                'review': 'На проверке',
                'completed': 'Завершен',
                'cancelled': 'Отменен'
            };
            return statuses[status] || status;
        }

        // Загрузка клиентов
        function loadClients() {
            if (!database || !database.users || !database.users.clients) return;
            
            const clients = database.users.clients;
            
            // Обновляем счетчик
            document.getElementById('clients-badge').textContent = clients.length;
            
            // Отображаем клиентов
            const container = document.getElementById('clients-grid');
            if (!container) return;
            
            if (clients.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--gray); grid-column: 1/-1;">
                        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="margin-bottom: 10px;">Клиентов пока нет</h3>
                        <p>Клиенты появятся после регистрации на платформе</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = clients.map(client => {
                // Получаем заказы клиента
                const clientOrders = database.orders?.filter(o => o.clientId === client.id) || [];
                const completedOrders = clientOrders.filter(o => o.status === 'completed').length;
                const totalSpent = clientOrders.reduce((sum, order) => sum + (order.budget || 0), 0);
                
                return `
                    <div class="client-card">
                        <div class="client-header">
                            <div class="client-avatar">${client.avatar || client.name?.charAt(0) || 'К'}</div>
                            <div class="client-info">
                                <h3>${client.name || 'Без имени'}</h3>
                                <div class="client-email">${client.email || 'Нет email'}</div>
                            </div>
                        </div>
                        
                        <div class="client-details">
                            <div class="client-detail">
                                <span class="client-detail-label">Телефон</span>
                                <span class="client-detail-value">${client.phone || 'Не указан'}</span>
                            </div>
                            <div class="client-detail">
                                <span class="client-detail-label">Telegram</span>
                                <span class="client-detail-value">${client.telegram ? '@' + client.telegram : 'Не указан'}</span>
                            </div>
                            <div class="client-detail">
                                <span class="client-detail-label">Заказов</span>
                                <span class="client-detail-value">${clientOrders.length}</span>
                            </div>
                            <div class="client-detail">
                                <span class="client-detail-label">Завершено</span>
                                <span class="client-detail-value">${completedOrders}</span>
                            </div>
                            <div class="client-detail">
                                <span class="client-detail-label">Потратил</span>
                                <span class="client-detail-value">${formatCurrency(totalSpent)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Поиск клиентов
        function searchClients() {
            const search = document.getElementById('clients-search').value.toLowerCase();
            const clients = document.querySelectorAll('.client-card');
            
            clients.forEach(client => {
                const text = client.textContent.toLowerCase();
                client.style.display = text.includes(search) ? 'block' : 'none';
            });
        }

        // Обновление клиентов
        async function refreshClients() {
            await loadDatabase();
            loadClients();
            showNotification('Список клиентов обновлен', 'success');
        }

        // Открыть модальное окно чата
        function openChatModal() {
            currentChatOrderId = currentOrderId;
            const order = database.orders.find(o => o.id === currentChatOrderId);
            if (!order) {
                showNotification('Заказ не найден', 'error');
                return;
            }
            
            document.getElementById('chat-modal-title').textContent = `Чат: ${order.projectName || 'Без названия'}`;
            loadChatMessages();
            document.getElementById('chat-modal').classList.add('active');
        }

        // Закрыть модальное окно чата
        function closeChatModal() {
            document.getElementById('chat-modal').classList.remove('active');
            currentChatOrderId = null;
        }

        // Загрузить сообщения чата
        function loadChatMessages() {
            if (!currentChatOrderId) return;
            
            const messages = database.messages?.filter(m => m.orderId === currentChatOrderId) || [];
            const container = document.getElementById('chat-messages');
            if (!container) return;
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        <p>Нет сообщений</p>
                    </div>
                `;
                return;
            }
            
            // Сортируем по времени
            messages.sort((a, b) => new Date(a.timestamp || 0) - new Date(b.timestamp || 0));
            
            container.innerHTML = messages.map(msg => {
                if (msg.sender === 'system') {
                    return `
                        <div class="message-system">
                            <i class="fas fa-info-circle"></i> ${msg.text || ''}
                        </div>
                    `;
                } else {
                    const isDeveloper = msg.sender === currentUser.id;
                    const sender = isDeveloper ? currentUser.name : 'Клиент';
                    
                    return `
                        <div class="message ${isDeveloper ? 'developer' : 'client'}">
                            <div class="message-sender">${sender}</div>
                            <div>${msg.text || ''}</div>
                            <div class="message-time">${msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}</div>
                        </div>
                    `;
                }
            }).join('');
            
            // Прокрутка вниз
            container.scrollTop = container.scrollHeight;
        }

        // Отправить сообщение
        async function sendMessage() {
            if (!currentChatOrderId) return;
            
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Создаем сообщение
            const newMessage = {
                id: 'msg_' + Date.now(),
                orderId: currentChatOrderId,
                text: message,
                sender: currentUser.id,
                timestamp: new Date().toISOString()
            };
            
            // Добавляем в базу
            if (!database.messages) database.messages = [];
            database.messages.push(newMessage);
            
            // Сохраняем базу
            const saved = await saveDatabase();
            if (saved) {
                // Очищаем поле ввода
                input.value = '';
                
                // Обновляем сообщения
                loadChatMessages();
            }
        }

        // Форматирование валюты
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Показать уведомление
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Выход
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Документ загружен, начинаем инициализацию...');
            init();
        });
    </script>
</body>
</html>
