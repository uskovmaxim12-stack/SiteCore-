<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiteCore | Панель разработчика</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Все стили остаются без изменений */
    </style>
</head>
<body>
    <!-- HTML структура остается без изменений -->

    <script>
        // Загрузка базы данных из localStorage
        function loadDatabase() {
            const database = localStorage.getItem('sitecore_database');
            if (database) {
                return JSON.parse(database);
            } else {
                // Если базы нет, создаем пустую структуру
                return {
                    users: { 
                        clients: [],
                        developers: [
                            {
                                id: "dev_1",
                                username: "Александр",
                                password: "789563",
                                avatar: "А",
                                email: "alexander@sitecore.ru"
                            },
                            {
                                id: "dev_2",
                                username: "Максим",
                                password: "140612",
                                avatar: "М",
                                email: "maxim@sitecore.ru"
                            }
                        ]
                    },
                    orders: [],
                    messages: [],
                    lastUpdate: new Date().toISOString()
                };
            }
        }

        // Сохранение базы данных
        function saveDatabase(database) {
            database.lastUpdate = new Date().toISOString();
            localStorage.setItem('sitecore_database', JSON.stringify(database));
        }

        // Инициализация
        function init() {
            // Проверка авторизации
            const userData = sessionStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            const currentUser = JSON.parse(userData);
            
            if (currentUser.type !== 'developer') {
                window.location.href = 'client.html';
                return;
            }

            // Загружаем базу данных
            const database = loadDatabase();
            
            // Обновляем информацию пользователя
            updateUserInfo(currentUser);
            loadDashboardData(currentUser, database);
            loadAvailableOrders(database);
        }

        // Обновление информации пользователя
        function updateUserInfo(currentUser) {
            const userInfoElement = document.getElementById('current-user-info');
            if (userInfoElement) {
                userInfoElement.innerHTML = `
                    <div class="user-avatar">${currentUser.avatar}</div>
                    <div class="user-name">${currentUser.name}</div>
                `;
            }

            const executorNameElement = document.getElementById('executor-name');
            if (executorNameElement) {
                executorNameElement.textContent = currentUser.name;
            }
            
            // Заголовок приветствия
            const now = new Date();
            const hours = now.getHours();
            let greeting;
            
            if (hours < 12) greeting = 'Доброе утро';
            else if (hours < 18) greeting = 'Добрый день';
            else greeting = 'Добрый вечер';
            
            const welcomeTitle = document.getElementById('welcome-title');
            if (welcomeTitle) {
                welcomeTitle.textContent = `${greeting}, ${currentUser.name}!`;
            }
        }

        // Загрузка дашборда
        function loadDashboardData(currentUser, database) {
            if (!database.orders) return;
            
            const orders = database.orders;
            const myOrders = orders.filter(order => order.assignedTo === currentUser.id);
            const availableOrders = orders.filter(order => !order.assignedTo && order.status === 'new');
            
            const statsBadge = document.getElementById('stats-badge');
            if (statsBadge) {
                statsBadge.innerHTML = `
                    <i class="fas fa-tasks"></i>
                    <span>${myOrders.length} активных заказов</span>
                `;
            }
            
            const quickStats = document.getElementById('quick-stats');
            if (quickStats) {
                quickStats.innerHTML = `
                    <div class="quick-stat">
                        <div class="quick-stat-value">${availableOrders.length}</div>
                        <div class="quick-stat-label">Доступных заказов</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value">${myOrders.length}</div>
                        <div class="quick-stat-label">Мои заказы</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value">${myOrders.filter(o => o.status === 'completed').length}</div>
                        <div class="quick-stat-label">Завершено</div>
                    </div>
                `;
            }
        }

        // Загрузка доступных заказов
        function loadAvailableOrders(database) {
            if (!database.orders) return;
            
            const orders = database.orders;
            const availableOrders = orders.filter(order => !order.assignedTo && order.status === 'new');
            const container = document.getElementById('available-orders');
            
            if (!container) return;
            
            if (availableOrders.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray); grid-column: 1/-1;">
                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="margin-bottom: 12px; font-size: 18px;">Нет доступных заказов</h3>
                        <p style="margin-bottom: 20px; max-width: 350px; margin: 0 auto 20px; font-size: 14px;">Все заказы взяты в работу. Загляните позже!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = availableOrders.map(order => {
                const client = database.users?.clients?.find(c => c.id === order.clientId) || order;
                
                return `
                    <div class="order-card" onclick="openOrderModal('${order.id}', true)">
                        <div class="order-card-header">
                            <div>
                                <h3>${order.projectName}</h3>
                                <div class="order-client">${client.name || order.clientName}</div>
                            </div>
                            <div class="order-status status-${order.status}">
                                Новый
                            </div>
                        </div>
                        
                        <div class="order-card-body">
                            <div class="order-details">
                                <div class="order-detail">
                                    <div class="order-detail-label">Тип</div>
                                    <div class="order-detail-value">${order.projectType === 'static' ? 'Статический' : 'Динамический'}</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Бюджет</div>
                                    <div class="order-detail-value">${formatCurrency(order.budget)}</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Срок</div>
                                    <div class="order-detail-value">${order.deadline} дн.</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Клиент</div>
                                    <div class="order-detail-value">${client.name || order.clientName}</div>
                                </div>
                            </div>
                            
                            <div class="order-prompt-preview">
                                ${(order.prompt || '').substring(0, 100)}...
                            </div>
                        </div>
                        
                        <div class="order-card-actions">
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); openOrderModal('${order.id}', true)">
                                <i class="fas fa-eye"></i> Подробнее
                            </button>
                            <button class="btn btn-primary" onclick="event.stopPropagation(); takeOrder('${order.id}')">
                                <i class="fas fa-hand-paper"></i> Взять в работу
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Форматирование валюты
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
