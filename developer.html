<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiteCore | Панель разработчика</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Добавляем адаптивные улучшения */
        
        /* Для очень маленьких экранов */
        @media (max-width: 360px) {
            .kanban-board {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .kanban-column {
                padding: 15px;
            }
            
            .kanban-header {
                padding-bottom: 10px;
                margin-bottom: 15px;
            }
            
            .kanban-item {
                padding: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-small {
                width: 100%;
                justify-content: center;
            }
            
            .modal-content {
                margin: 10px;
                max-height: 95vh;
            }
        }
        
        /* Для планшетов в портретной ориентации */
        @media (max-width: 768px) and (min-width: 481px) {
            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Для телефонов в альбомной ориентации */
        @media (max-width: 896px) and (orientation: landscape) {
            .container {
                padding: 20px;
            }
            
            .welcome-section {
                padding: 25px;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .search-box {
                width: 100%;
            }
            
            .section-tabs {
                flex-wrap: wrap;
            }
            
            .section-tab {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
        
        /* Для очень высоких экранов */
        @media (min-height: 1000px) {
            .kanban-list {
                min-height: 500px;
            }
        }
        
        /* Улучшение для 5 колонок канбана */
        @media (min-width: 1400px) {
            .kanban-board {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        /* Индикатор загрузки */
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }
        
        .loading-indicator.active {
            display: block;
        }
        
        .loading-indicator i {
            font-size: 24px;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Улучшение кнопок для touch устройств */
        .btn, .btn-small, .kanban-item, .order-card {
            touch-action: manipulation;
        }
        
        .btn-small {
            min-height: 36px;
        }
        
        /* Улучшение скролла */
        .kanban-list, .chat-messages, .prompt-content {
            scrollbar-width: thin;
            scrollbar-color: var(--gray-light) var(--gray-lighter);
        }
        
        .kanban-list::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar,
        .prompt-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .kanban-list::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track,
        .prompt-content::-webkit-scrollbar-track {
            background: var(--gray-lighter);
            border-radius: 3px;
        }
        
        .kanban-list::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb,
        .prompt-content::-webkit-scrollbar-thumb {
            background: var(--gray-light);
            border-radius: 3px;
        }
        
        .kanban-list::-webkit-scrollbar-thumb:hover,
        .chat-messages::-webkit-scrollbar-thumb:hover,
        .prompt-content::-webkit-scrollbar-thumb:hover {
            background: var(--gray);
        }
    </style>
</head>
<body>
    <!-- HTML структура остается без изменений -->
    <!-- Добавляем индикатор загрузки в начало контейнера -->
    
    <div class="container">
        <!-- Приветствие -->
        <div class="welcome-section">
            <div class="welcome-header">
                <h1 id="welcome-title">Загрузка...</h1>
                <div class="stats-badge" id="stats-badge">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
            
            <div class="welcome-grid">
                <div class="welcome-info">
                    <h2 id="executor-name">Загрузка...</h2>
                    <p>Загружаем данные...</p>
                    <div class="quick-stats" id="quick-stats">
                        <!-- Будет заполнено JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Индикатор загрузки -->
        <div class="loading-indicator active" id="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Загрузка данных...</p>
        </div>

        <!-- Остальной HTML остается без изменений -->
    </div>

    <script>
        // Глобальные переменные
        const DB_CONFIG = {
            API_URL: 'https://api.jsonbin.io/v3/b',
            BIN_ID: '66b3d9c5ad19ca34f8c48e0d',
            API_KEY: '$2b$10$LQYjMwTj2wXGJfX8b7K6DeoEJpJX5qYQY9t8rFqGtHvK1lM3nP4oS'
        };

        let currentUser = null;
        let database = null;
        let isLoading = false;

        // Инициализация
        async function init() {
            // Проверка авторизации
            const userData = sessionStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = JSON.parse(userData);
            
            if (currentUser.type !== 'developer') {
                window.location.href = 'client.html';
                return;
            }

            // Показываем базовую информацию сразу
            updateUserInfo();
            
            // Быстрая загрузка - сначала показываем данные из localStorage
            const cachedData = localStorage.getItem('sitecore_cached_data');
            if (cachedData) {
                try {
                    database = JSON.parse(cachedData);
                    loadDashboardData();
                    loadAvailableOrders();
                    
                    // Скрываем индикатор загрузки
                    document.getElementById('loading-indicator').classList.remove('active');
                } catch (e) {
                    console.error('Ошибка парсинга кэша:', e);
                }
            }

            // Затем загружаем свежие данные в фоне
            setTimeout(() => loadDatabase(), 100);
        }

        // Быстрая загрузка базы данных
        async function loadDatabase() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                const response = await fetch(`${DB_CONFIG.API_URL}/${DB_CONFIG.BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': DB_CONFIG.API_KEY }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    database = data.record;
                    
                    // Кэшируем данные
                    localStorage.setItem('sitecore_cached_data', JSON.stringify(database));
                    
                    // Обновляем UI
                    loadDashboardData();
                    loadAvailableOrders();
                    
                    // Скрываем индикатор загрузки
                    document.getElementById('loading-indicator').classList.remove('active');
                }
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                // Если данных еще нет в кэше, показываем сообщение
                if (!database) {
                    document.getElementById('loading-indicator').innerHTML = `
                        <i class="fas fa-wifi-slash"></i>
                        <p>Ошибка загрузки. Проверьте соединение.</p>
                    `;
                }
            } finally {
                isLoading = false;
            }
        }

        // Обновление информации пользователя
        function updateUserInfo() {
            document.getElementById('current-user-info').innerHTML = `
                <div class="user-avatar">${currentUser.avatar}</div>
                <div class="user-name">${currentUser.name}</div>
            `;

            document.getElementById('executor-name').textContent = currentUser.name;
            
            // Заголовок приветствия
            const now = new Date();
            const hours = now.getHours();
            let greeting;
            
            if (hours < 12) greeting = 'Доброе утро';
            else if (hours < 18) greeting = 'Добрый день';
            else greeting = 'Добрый вечер';
            
            document.getElementById('welcome-title').textContent = `${greeting}, ${currentUser.name}!`;
        }

        // Загрузка дашборда
        function loadDashboardData() {
            if (!database || !database.orders) return;
            
            const orders = database.orders;
            const myOrders = orders.filter(order => order.assignedTo === currentUser.id);
            const availableOrders = orders.filter(order => !order.assignedTo && order.status === 'new');
            
            document.getElementById('stats-badge').innerHTML = `
                <i class="fas fa-tasks"></i>
                <span>${myOrders.length} активных заказов</span>
            `;
            
            document.getElementById('quick-stats').innerHTML = `
                <div class="quick-stat">
                    <div class="quick-stat-value">${availableOrders.length}</div>
                    <div class="quick-stat-label">Доступных заказов</div>
                </div>
                <div class="quick-stat">
                    <div class="quick-stat-value">${myOrders.length}</div>
                    <div class="quick-stat-label">Мои заказы</div>
                </div>
                <div class="quick-stat">
                    <div class="quick-stat-value">${myOrders.filter(o => o.status === 'completed').length}</div>
                    <div class="quick-stat-label">Завершено</div>
                </div>
            `;
        }

        // Загрузка доступных заказов
        function loadAvailableOrders() {
            if (!database || !database.orders) return;
            
            const orders = database.orders;
            const availableOrders = orders.filter(order => !order.assignedTo && order.status === 'new');
            const container = document.getElementById('available-orders');
            
            if (availableOrders.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray); grid-column: 1/-1;">
                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="margin-bottom: 12px; font-size: 18px;">Нет доступных заказов</h3>
                        <p style="margin-bottom: 20px; max-width: 350px; margin: 0 auto 20px; font-size: 14px;">Все заказы взяты в работу. Загляните позже!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = availableOrders.map(order => {
                const client = database.users?.clients?.find(c => c.id === order.clientId) || order;
                
                return `
                    <div class="order-card" onclick="openOrderModal('${order.id}', true)">
                        <div class="order-card-header">
                            <div>
                                <h3>${order.projectName}</h3>
                                <div class="order-client">${client.name || order.clientName}</div>
                            </div>
                            <div class="order-status status-${order.status}">
                                Новый
                            </div>
                        </div>
                        
                        <div class="order-card-body">
                            <div class="order-details">
                                <div class="order-detail">
                                    <div class="order-detail-label">Тип</div>
                                    <div class="order-detail-value">${order.projectType === 'static' ? 'Статический' : 'Динамический'}</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Бюджет</div>
                                    <div class="order-detail-value">${formatCurrency(order.budget)}</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Срок</div>
                                    <div class="order-detail-value">${order.deadline} дн.</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Клиент</div>
                                    <div class="order-detail-value">${client.name || order.clientName}</div>
                                </div>
                            </div>
                            
                            <div class="order-prompt-preview">
                                ${(order.prompt || '').substring(0, 100)}...
                            </div>
                        </div>
                        
                        <div class="order-card-actions">
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); openOrderModal('${order.id}', true)">
                                <i class="fas fa-eye"></i> Подробнее
                            </button>
                            <button class="btn btn-primary" onclick="event.stopPropagation(); takeOrder('${order.id}')">
                                <i class="fas fa-hand-paper"></i> Взять в работу
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Взять заказ в работу
        async function takeOrder(orderId) {
            if (!database || !database.orders) return;
            
            const orderIndex = database.orders.findIndex(order => order.id === orderId);
            
            if (orderIndex === -1) {
                showNotification('Заказ не найден', 'error');
                return;
            }
            
            database.orders[orderIndex].assignedTo = currentUser.id;
            database.orders[orderIndex].status = 'in_progress';
            database.orders[orderIndex].updatedAt = new Date().toISOString();
            
            // Добавляем системное сообщение
            if (!database.messages) database.messages = [];
            database.messages.push({
                id: 'msg_' + Date.now(),
                orderId: orderId,
                text: `${currentUser.name} взял заказ в работу`,
                sender: 'system',
                timestamp: new Date().toISOString()
            });
            
            // Сохраняем
            await saveDatabase();
            
            showNotification('Заказ успешно взят в работу!', 'success');
            
            // Перезагружаем данные
            setTimeout(() => {
                loadDashboardData();
                loadAvailableOrders();
                if (currentView === 'my') loadMyOrders();
            }, 300);
        }

        // Сохранение базы данных
        async function saveDatabase() {
            try {
                const response = await fetch(`${DB_CONFIG.API_URL}/${DB_CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DB_CONFIG.API_KEY
                    },
                    body: JSON.stringify(database)
                });
                
                if (response.ok) {
                    // Обновляем кэш
                    localStorage.setItem('sitecore_cached_data', JSON.stringify(database));
                    return true;
                }
            } catch (error) {
                console.error('Ошибка сохранения:', error);
            }
            return false;
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Добавляем обработчик для обновления данных при фокусе
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && database) {
                    // При возвращении на вкладку обновляем данные
                    setTimeout(() => loadDatabase(), 1000);
                }
            });
            
            // Периодическое обновление данных каждые 30 секунд
            setInterval(() => {
                if (!document.hidden && database) {
                    loadDatabase();
                }
            }, 30000);
        });
    </script>
</body>
</html>
