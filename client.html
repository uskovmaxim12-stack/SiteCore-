<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiteCore | Личный кабинет клиента</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Все существующие стили остаются без изменений */
        /* Добавляем только адаптивные улучшения */
        
        /* Для очень маленьких экранов */
        @media (max-width: 360px) {
            .order-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .order-status {
                align-self: flex-start;
            }
            
            .order-details {
                grid-template-columns: 1fr;
            }
            
            .profile-details {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Для планшетов в портретной ориентации */
        @media (max-width: 768px) and (min-width: 481px) {
            .orders-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Для телефонов в альбомной ориентации */
        @media (max-width: 896px) and (orientation: landscape) {
            .container {
                padding: 20px;
            }
            
            .welcome-section {
                padding: 25px;
            }
            
            .welcome-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding: 6px;
            }
            
            .tab {
                white-space: nowrap;
                padding: 12px 16px;
            }
        }
        
        /* Для очень высоких экранов */
        @media (min-height: 1000px) {
            .container {
                max-width: 1400px;
            }
            
            .orders-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Улучшение загрузки */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* Стили для инпутов с ограничениями */
        .form-group input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .form-group input[type="number"]::-webkit-outer-spin-button,
        .form-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Весь HTML остается без изменений, кроме формы создания заказа -->
    <!-- Вставляем исправленную форму создания заказа -->
    
    <!-- Создание заказа -->
    <div id="create-tab" class="tab-content">
        <div class="create-order-section">
            <h2>Создание нового заказа</h2>
            <form id="create-order-form" onsubmit="return createOrder(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="project-name">Название проекта *</label>
                        <input type="text" id="project-name" placeholder="Например: Интернет-магазин одежды" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-type">Тип сайта *</label>
                        <select id="project-type" required>
                            <option value="">Выберите тип</option>
                            <option value="static">Статический сайт</option>
                            <option value="dynamic">Динамический сайт</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-budget">Бюджет (₽) *</label>
                        <input type="number" id="project-budget" 
                               placeholder="Например: 30000" 
                               min="300" 
                               max="1000000" 
                               step="100" 
                               required
                               oninput="validateBudget(this)">
                        <small style="color: var(--gray); font-size: 12px; margin-top: 4px; display: block;">
                            От 300 ₽ до 1 000 000 ₽
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-deadline">Срок (дней) *</label>
                        <input type="number" id="project-deadline" 
                               placeholder="Например: 14" 
                               min="3" 
                               max="30" 
                               required
                               oninput="validateDeadline(this)">
                        <small style="color: var(--gray); font-size: 12px; margin-top: 4px; display: block;">
                            От 3 до 30 дней
                        </small>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="project-prompt">Техническое задание (промт) *</label>
                        <textarea id="project-prompt" rows="8" placeholder="Опишите подробно, какой сайт вам нужен. Укажите цели, предпочтения по дизайну, функционал и т.д. Минимум 300 символов, максимум 2500." required></textarea>
                        <div class="prompt-counter" id="prompt-counter">0 символов (минимум 300, максимум 2500)</div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">
                        <i class="fas fa-times"></i> Очистить
                    </button>
                    <button type="submit" class="btn btn-primary" id="create-order-btn">
                        <i class="fas fa-plus-circle"></i> Создать заказ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Глобальные переменные
        const DB_CONFIG = {
            API_URL: 'https://api.jsonbin.io/v3/b',
            BIN_ID: '66b3d9c5ad19ca34f8c48e0d',
            API_KEY: '$2b$10$LQYjMwTj2wXGJfX8b7K6DeoEJpJX5qYQY9t8rFqGtHvK1lM3nP4oS'
        };

        let currentUser = null;
        let database = null;
        let currentChatOrderId = null;
        let isLoading = false;

        // Инициализация
        async function init() {
            // Проверка авторизации
            const userData = sessionStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = JSON.parse(userData);
            
            if (currentUser.type !== 'client') {
                window.location.href = 'developer.html';
                return;
            }

            // Быстрая загрузка - сначала показываем данные из localStorage
            const cachedData = localStorage.getItem('sitecore_cached_data');
            if (cachedData) {
                database = JSON.parse(cachedData);
                updateUserInfo();
                loadClientOrders();
                updateProfile();
            }

            // Затем загружаем свежие данные
            await loadDatabase();
        }

        // Быстрая загрузка базы данных
        async function loadDatabase() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                const response = await fetch(`${DB_CONFIG.API_URL}/${DB_CONFIG.BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': DB_CONFIG.API_KEY }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    database = data.record;
                    
                    // Кэшируем данные
                    localStorage.setItem('sitecore_cached_data', JSON.stringify(database));
                    
                    // Обновляем UI если уже загружены старые данные
                    if (document.getElementById('welcome-title')) {
                        updateUserInfo();
                        loadClientOrders();
                        updateProfile();
                    }
                } else {
                    console.warn('Используем кэшированные данные');
                }
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                // Используем кэшированные данные если есть
                if (!database) {
                    const cachedData = localStorage.getItem('sitecore_cached_data');
                    if (cachedData) {
                        database = JSON.parse(cachedData);
                    } else {
                        database = { users: { clients: [], developers: [] }, orders: [], messages: [] };
                    }
                }
            } finally {
                isLoading = false;
            }
        }

        // Валидация бюджета
        function validateBudget(input) {
            let value = parseInt(input.value);
            if (isNaN(value)) value = 0;
            
            if (value < 300) {
                input.value = 300;
                showNotification('Минимальный бюджет: 300 ₽', 'warning');
            } else if (value > 1000000) {
                input.value = 1000000;
                showNotification('Максимальный бюджет: 1 000 000 ₽', 'warning');
            }
        }

        // Валидация срока
        function validateDeadline(input) {
            let value = parseInt(input.value);
            if (isNaN(value)) value = 0;
            
            if (value < 3) {
                input.value = 3;
                showNotification('Минимальный срок: 3 дня', 'warning');
            } else if (value > 30) {
                input.value = 30;
                showNotification('Максимальный срок: 30 дней', 'warning');
            }
        }

        // Создание заказа
        async function createOrder(event) {
            event.preventDefault();
            
            const projectName = document.getElementById('project-name').value.trim();
            const projectType = document.getElementById('project-type').value;
            const budget = parseInt(document.getElementById('project-budget').value);
            const deadline = parseInt(document.getElementById('project-deadline').value);
            const prompt = document.getElementById('project-prompt').value.trim();
            
            // Проверка промта
            if (prompt.length < 300) {
                showNotification('Техническое задание должно содержать минимум 300 символов', 'error');
                return;
            }
            
            if (prompt.length > 2500) {
                showNotification('Техническое задание должно содержать максимум 2500 символов', 'error');
                return;
            }
            
            // Проверка бюджета
            if (budget < 300 || budget > 1000000) {
                showNotification('Бюджет должен быть от 300 ₽ до 1 000 000 ₽', 'error');
                return;
            }
            
            // Проверка срока
            if (deadline < 3 || deadline > 30) {
                showNotification('Срок должен быть от 3 до 30 дней', 'error');
                return;
            }
            
            // Создаем новый заказ
            const newOrder = {
                id: 'order_' + Date.now(),
                clientId: currentUser.id,
                clientName: currentUser.name,
                clientEmail: currentUser.email,
                clientPhone: currentUser.phone,
                clientTelegram: currentUser.telegram,
                projectName: projectName,
                projectType: projectType,
                budget: budget,
                deadline: deadline,
                prompt: prompt,
                status: 'new',
                assignedTo: null,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Добавляем заказ в базу
            if (!database.orders) database.orders = [];
            database.orders.push(newOrder);
            
            // Добавляем системное сообщение
            if (!database.messages) database.messages = [];
            const systemMessage = {
                id: 'msg_' + Date.now(),
                orderId: newOrder.id,
                text: `Заказ "${projectName}" создан. Ожидайте, пока разработчик возьмет его в работу.`,
                sender: 'system',
                timestamp: new Date().toISOString()
            };
            
            database.messages.push(systemMessage);
            
            // Сохраняем базу
            try {
                const response = await fetch(`${DB_CONFIG.API_URL}/${DB_CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DB_CONFIG.API_KEY
                    },
                    body: JSON.stringify(database)
                });
                
                if (response.ok) {
                    // Обновляем кэш
                    localStorage.setItem('sitecore_cached_data', JSON.stringify(database));
                    
                    showNotification('Заказ успешно создан!', 'success');
                    
                    // Очищаем форму
                    clearForm();
                    
                    // Переключаемся на вкладку заказов
                    showTab('orders');
                    
                    // Перезагружаем заказы
                    loadClientOrders();
                } else {
                    showNotification('Ошибка при создании заказа', 'error');
                }
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                showNotification('Ошибка соединения. Попробуйте снова.', 'error');
            }
        }

        // Остальные функции остаются без изменений, кроме оптимизации загрузки
        
        // Обновление профиля (оптимизированная версия)
        function updateProfile() {
            if (!database || !database.orders) return;
            
            const clientOrders = database.orders.filter(order => order.clientId === currentUser.id);
            
            document.getElementById('profile-avatar').textContent = currentUser.avatar;
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-email').textContent = currentUser.email;
            
            document.getElementById('detail-email').textContent = currentUser.email;
            document.getElementById('detail-phone').textContent = currentUser.phone || 'Не указан';
            document.getElementById('detail-telegram').textContent = currentUser.telegram ? '@' + currentUser.telegram : 'Не указан';
            
            document.getElementById('detail-total-orders').textContent = clientOrders.length;
            document.getElementById('detail-active-orders').textContent = clientOrders.filter(o => o.status !== 'completed' && o.status !== 'cancelled').length;
            document.getElementById('detail-completed-orders').textContent = clientOrders.filter(o => o.status === 'completed').length;
        }

        // Обновление информации пользователя
        function updateUserInfo() {
            document.getElementById('current-user-info').innerHTML = `
                <div class="user-avatar">${currentUser.avatar}</div>
                <div class="user-name">${currentUser.name}</div>
            `;

            document.getElementById('client-name').textContent = currentUser.name;
            
            // Заголовок приветствия
            const now = new Date();
            const hours = now.getHours();
            let greeting;
            
            if (hours < 12) greeting = 'Доброе утро';
            else if (hours < 18) greeting = 'Добрый день';
            else greeting = 'Добрый вечер';
            
            document.getElementById('welcome-title').textContent = `${greeting}, ${currentUser.name}!`;
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Фокус на поле промта при загрузке формы
            document.getElementById('project-prompt')?.addEventListener('focus', function() {
                updatePromptCounter();
            });
            
            // Валидация полей при изменении
            document.getElementById('project-budget')?.addEventListener('change', function() {
                validateBudget(this);
            });
            
            document.getElementById('project-deadline')?.addEventListener('change', function() {
                validateDeadline(this);
            });
        });
    </script>
</body>
</html>
