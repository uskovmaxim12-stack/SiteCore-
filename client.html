<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiteCore | Личный кабинет клиента</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Все существующие стили остаются без изменений */
        /* Добавляем только адаптивные улучшения */
        
        /* Для очень маленьких экранов */
        @media (max-width: 360px) {
            .order-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .order-status {
                align-self: flex-start;
            }
            
            .order-details {
                grid-template-columns: 1fr;
            }
            
            .profile-details {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Для планшетов в портретной ориентации */
        @media (max-width: 768px) and (min-width: 481px) {
            .orders-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Для телефонов в альбомной ориентации */
        @media (max-width: 896px) and (orientation: landscape) {
            .container {
                padding: 20px;
            }
            
            .welcome-section {
                padding: 25px;
            }
            
            .welcome-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding: 6px;
            }
            
            .tab {
                white-space: nowrap;
                padding: 12px 16px;
            }
        }
        
        /* Для очень высоких экранов */
        @media (min-height: 1000px) {
            .container {
                max-width: 1400px;
            }
            
            .orders-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Улучшение загрузки */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* Стили для инпутов с ограничениями */
        .form-group input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .form-group input[type="number"]::-webkit-outer-spin-button,
        .form-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Весь HTML остается без изменений -->
    <!-- Изменяем только скриптовую часть -->

    <script>
        // Загрузка базы данных из localStorage
        function loadDatabase() {
            const database = localStorage.getItem('sitecore_database');
            if (database) {
                return JSON.parse(database);
            } else {
                // Если базы нет, создаем пустую структуру
                return {
                    users: { clients: [], developers: [] },
                    orders: [],
                    messages: [],
                    lastUpdate: new Date().toISOString()
                };
            }
        }

        // Сохранение базы данных
        function saveDatabase(database) {
            database.lastUpdate = new Date().toISOString();
            localStorage.setItem('sitecore_database', JSON.stringify(database));
        }

        // Инициализация
        function init() {
            // Проверка авторизации
            const userData = sessionStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            const currentUser = JSON.parse(userData);
            
            if (currentUser.type !== 'client') {
                window.location.href = 'developer.html';
                return;
            }

            // Загружаем базу данных
            const database = loadDatabase();
            
            // Обновляем информацию пользователя
            updateUserInfo(currentUser);
            loadClientOrders(currentUser, database);
            updateProfile(currentUser, database);
            setupEventListeners(currentUser, database);
        }

        // Обновление информации пользователя
        function updateUserInfo(currentUser) {
            const userInfoElement = document.getElementById('current-user-info');
            if (userInfoElement) {
                userInfoElement.innerHTML = `
                    <div class="user-avatar">${currentUser.avatar}</div>
                    <div class="user-name">${currentUser.name}</div>
                `;
            }

            const clientNameElement = document.getElementById('client-name');
            if (clientNameElement) {
                clientNameElement.textContent = currentUser.name;
            }
            
            // Заголовок приветствия
            const now = new Date();
            const hours = now.getHours();
            let greeting;
            
            if (hours < 12) greeting = 'Доброе утро';
            else if (hours < 18) greeting = 'Добрый день';
            else greeting = 'Добрый вечер';
            
            const welcomeTitle = document.getElementById('welcome-title');
            if (welcomeTitle) {
                welcomeTitle.textContent = `${greeting}, ${currentUser.name}!`;
            }
        }

        // Загрузка заказов клиента
        function loadClientOrders(currentUser, database) {
            if (!database.orders) return;
            
            const clientOrders = database.orders.filter(order => order.clientId === currentUser.id);
            
            // Обновляем статистику
            const totalOrders = clientOrders.length;
            const activeOrders = clientOrders.filter(o => o.status !== 'completed' && o.status !== 'cancelled').length;
            const completedOrders = clientOrders.filter(o => o.status === 'completed').length;
            
            const statsBadge = document.getElementById('stats-badge');
            if (statsBadge) {
                statsBadge.innerHTML = `
                    <i class="fas fa-tasks"></i>
                    <span>${activeOrders} активных заказов</span>
                `;
            }
            
            const quickStats = document.getElementById('quick-stats');
            if (quickStats) {
                quickStats.innerHTML = `
                    <div class="quick-stat">
                        <div class="quick-stat-value">${totalOrders}</div>
                        <div class="quick-stat-label">Всего заказов</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value">${activeOrders}</div>
                        <div class="quick-stat-label">В работе</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value">${completedOrders}</div>
                        <div class="quick-stat-label">Завершено</div>
                    </div>
                `;
            }
            
            // Отображаем заказы
            const container = document.getElementById('orders-grid');
            if (!container) return;
            
            if (clientOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px; color: var(--gray); grid-column: 1/-1;">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>У вас пока нет заказов</h3>
                        <p>Создайте свой первый заказ на разработку сайта</p>
                        <button class="btn btn-primary" onclick="showTab('create')">
                            <i class="fas fa-plus-circle"></i> Создать заказ
                        </button>
                    </div>
                `;
                return;
            }
            
            // Сортируем по дате создания (новые сначала)
            clientOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            container.innerHTML = clientOrders.map(order => {
                const statusTexts = {
                    'new': 'Новый',
                    'in-progress': 'В работе',
                    'review': 'На проверке',
                    'completed': 'Завершен',
                    'cancelled': 'Отменен'
                };
                
                const statusColors = {
                    'new': 'status-new',
                    'in-progress': 'status-in-progress',
                    'review': 'status-review',
                    'completed': 'status-completed',
                    'cancelled': 'status-cancelled'
                };
                
                // Получаем последнее сообщение
                const orderMessages = database.messages ? database.messages.filter(m => m.orderId === order.id) : [];
                const lastMessage = orderMessages[orderMessages.length - 1];
                let lastMessageText = 'Нет сообщений';
                
                if (lastMessage) {
                    const time = new Date(lastMessage.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const senderName = lastMessage.sender === currentUser.id ? 'Вы' : (lastMessage.senderName || 'Разработчик');
                    lastMessageText = `${senderName}: ${lastMessage.text.substring(0, 50)}... (${time})`;
                }
                
                return `
                    <div class="order-card">
                        <div class="order-card-header">
                            <div>
                                <h3>${order.projectName}</h3>
                                <div class="order-client">Создан: ${new Date(order.createdAt).toLocaleDateString()}</div>
                            </div>
                            <div class="order-status ${statusColors[order.status] || 'status-new'}">
                                ${statusTexts[order.status] || 'Новый'}
                            </div>
                        </div>
                        
                        <div class="order-card-body">
                            <div class="order-details">
                                <div class="order-detail">
                                    <div class="order-detail-label">Тип</div>
                                    <div class="order-detail-value">${order.projectType === 'static' ? 'Статический' : 'Динамический'}</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Бюджет</div>
                                    <div class="order-detail-value">${formatCurrency(order.budget)}</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Срок</div>
                                    <div class="order-detail-value">${order.deadline} дней</div>
                                </div>
                                <div class="order-detail">
                                    <div class="order-detail-label">Разработчик</div>
                                    <div class="order-detail-value">${order.assignedTo ? 'Назначен' : 'В поиске'}</div>
                                </div>
                            </div>
                            
                            <div class="order-prompt-preview">
                                ${(order.prompt || '').substring(0, 100)}...
                            </div>
                            
                            <div style="font-size: 12px; color: var(--gray); margin-top: 10px;">
                                <i class="far fa-comment"></i> ${lastMessageText}
                            </div>
                        </div>
                        
                        <div class="order-card-actions">
                            <button class="btn btn-secondary btn-small" onclick="openChat('${order.id}')">
                                <i class="fas fa-comment"></i> Чат
                            </button>
                            ${order.status === 'new' ? `
                                <button class="btn btn-secondary btn-small" onclick="cancelOrder('${order.id}')">
                                    <i class="fas fa-times"></i> Отменить
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Форматирование валюты
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
